<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or settings.app_name }}</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      (function () {
        const root = document.documentElement;
        const prefersDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const STORAGE_KEY = 'inbox-steward:theme-settings';
        const LEGACY_THEME_KEY = 'theme';
        const manualModes = ['light', 'dark', 'oled'];
        const classMap = {
          light: [],
          dark: ['dark'],
          oled: ['dark', 'oled'],
        };

        const defaultSettings = {
          mode: 'auto',
          autoDark: 'dark',
        };

        const syncBodyTheme = (mode) => {
          const body = document.body;
          if (body) {
            body.dataset.theme = mode;
          }
        };

        const applyThemeClasses = (theme) => {
          const next = manualModes.includes(theme) ? theme : 'light';
          root.classList.remove('dark', 'oled');
          classMap[next].forEach((cls) => root.classList.add(cls));
          root.dataset.theme = next;
          syncBodyTheme(next);
          root.style.colorScheme = next === 'light' ? 'light' : 'dark';
        };

        const sanitizeSettings = (settings) => {
          const sanitized = { ...defaultSettings };
          if (settings && typeof settings === 'object') {
            const { mode, autoDark } = settings;
            if (mode && (manualModes.includes(mode) || mode === 'auto')) {
              sanitized.mode = mode;
            }
            if (autoDark && (autoDark === 'dark' || autoDark === 'oled')) {
              sanitized.autoDark = autoDark;
            }
          }
          return sanitized;
        };

        const resolveTheme = (settings) => {
          if (settings.mode === 'auto') {
            return prefersDarkQuery.matches ? settings.autoDark : 'light';
          }
          return manualModes.includes(settings.mode) ? settings.mode : 'light';
        };

        const migrateLegacySettings = () => {
          try {
            const legacy = localStorage.getItem(LEGACY_THEME_KEY);
            if (legacy && manualModes.includes(legacy)) {
              const migrated = sanitizeSettings({ mode: legacy });
              localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
              localStorage.removeItem(LEGACY_THEME_KEY);
              return migrated;
            }
          } catch (error) {
            // Ignore migration errors and fall back to defaults.
          }
          return null;
        };

        const loadSettings = () => {
          try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
              return sanitizeSettings(JSON.parse(stored));
            }
          } catch (error) {
            // Ignore parse/storage errors.
          }
          const migrated = migrateLegacySettings();
          if (migrated) {
            return migrated;
          }
          return { ...defaultSettings };
        };

        let themeSettings = loadSettings();

        const dispatchThemeChange = () => {
          document.dispatchEvent(
            new CustomEvent('themechange', {
              detail: {
                theme: root.dataset.theme || 'light',
                mode: themeSettings.mode,
                autoDark: themeSettings.autoDark,
              },
            }),
          );
        };

        const setThemeSettings = (updates = {}, options = {}) => {
          const { persist = true, notify = true } = options;
          themeSettings = sanitizeSettings({ ...themeSettings, ...updates });
          const resolved = resolveTheme(themeSettings);
          applyThemeClasses(resolved);
          if (persist) {
            try {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(themeSettings));
            } catch (error) {
              // Ignore persistence errors.
            }
          }
          if (notify) {
            dispatchThemeChange();
          }
          return resolved;
        };

        applyThemeClasses(resolveTheme(themeSettings));

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            syncBodyTheme(root.dataset.theme || resolveTheme(themeSettings));
          });
        } else {
          syncBodyTheme(root.dataset.theme || resolveTheme(themeSettings));
        }

        window.__themeController = {
          apply: (mode) => {
            if (mode === 'auto' || manualModes.includes(mode)) {
              return setThemeSettings({ mode });
            }
            return root.dataset.theme || 'light';
          },
          current: () => root.dataset.theme || resolveTheme(themeSettings),
          mode: () => themeSettings.mode,
          autoPreference: () => themeSettings.autoDark,
          setAutoPreference: (preference) => {
            if (preference === 'dark' || preference === 'oled') {
              const notify = themeSettings.mode === 'auto';
              return setThemeSettings(
                { autoDark: preference },
                { persist: true, notify },
              );
            }
            return themeSettings.autoDark;
          },
          settings: () => ({ ...themeSettings }),
        };

        window.addEventListener('storage', (event) => {
          if (event.key === STORAGE_KEY) {
            let nextSettings = { ...defaultSettings };
            if (event.newValue) {
              try {
                nextSettings = sanitizeSettings(JSON.parse(event.newValue));
              } catch (error) {
                // Ignore parse errors and fall back to defaults.
              }
            }
            themeSettings = nextSettings;
            applyThemeClasses(resolveTheme(themeSettings));
            dispatchThemeChange();
          }
        });

        const handleSystemThemeChange = () => {
          if (themeSettings.mode === 'auto') {
            applyThemeClasses(resolveTheme(themeSettings));
            dispatchThemeChange();
          }
        };

        if (typeof prefersDarkQuery.addEventListener === 'function') {
          prefersDarkQuery.addEventListener('change', handleSystemThemeChange);
        } else if (typeof prefersDarkQuery.addListener === 'function') {
          prefersDarkQuery.addListener(handleSystemThemeChange);
        }

        dispatchThemeChange();
      })();
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#eef2ff',
                100: '#e0e7ff',
                200: '#c7d2fe',
                500: '#6366f1',
                600: '#4f46e5',
                700: '#4338ca',
              },
            },
            boxShadow: {
              focus: '0 0 0 3px rgba(99, 102, 241, 0.35)',
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link rel="stylesheet" href="/static/css/styles.css" />
  </head>
  <body class="bg-white dark:bg-slate-950 min-h-screen font-[Inter] text-slate-800 dark:text-slate-100 transition-colors preloader-active">
    <div id="preloader" class="preloader" role="status" aria-live="polite">
      <div class="preloader-content">
        <img
          src="/static/img/is-logo.png"
          alt="Inbox Steward logo"
          class="preloader-logo"
          data-preloader-logo
        />
        <div class="preloader-spinner" aria-hidden="true"></div>
        <p class="preloader-text">Warming up your Inbox Steward…</p>
      </div>
    </div>
    <nav class="relative bg-white dark:bg-slate-900/90 border-b border-slate-200 dark:border-slate-800 z-40">
      <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <a
          href="/"
          class="text-2xl font-semibold text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 focus:outline-none focus:ring-2 focus:ring-brand-500/60 rounded"
          aria-label="Go to home"
        >
          {{ settings.app_name }}
        </a>
        <div class="flex items-center gap-3">
          <div class="hidden md:flex items-center gap-4 text-sm font-medium text-slate-600 dark:text-slate-300">
            <a href="/" data-nav-index="0" class="hover:text-brand-600 dark:hover:text-brand-400">Dashboard</a>
            <a href="/what-if" data-nav-index="1" class="hover:text-brand-600 dark:hover:text-brand-400">What If</a>
            <a href="/settings" data-nav-index="2" class="hover:text-brand-600 dark:hover:text-brand-400">Settings</a>
            <a href="/debug" data-nav-index="3" class="hover:text-brand-600 dark:hover:text-brand-400">Debug</a>
            <a
              href="/docs"
              data-nav-index="4"
              class="hover:text-brand-600 dark:hover:text-brand-400"
              target="_blank"
              rel="noopener noreferrer"
              >API Docs</a
            >
            <div class="theme-menu-root" data-theme-menu-root>
              <button
                type="button"
                data-theme-menu-toggle
                class="inline-flex items-center gap-2 rounded-full border border-slate-200 dark:border-slate-700 px-3 py-1 text-xs uppercase tracking-wide text-slate-600 dark:text-slate-200 hover:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/60 theme-toggle-control"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="theme-menu-desktop"
              >
                <span data-theme-icon class="text-base leading-none">☀️</span>
                <span data-theme-label>Light</span>
                <svg
                  class="theme-menu-caret"
                  width="12"
                  height="12"
                  viewBox="0 0 12 12"
                  aria-hidden="true"
                >
                  <path
                    d="M3 4.5L6 7.5L9 4.5"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <div
                id="theme-menu-desktop"
                class="theme-menu"
                data-theme-menu-panel
                role="menu"
                aria-hidden="true"
              >
                <div class="theme-menu-section" role="none">
                  <p class="theme-menu-heading">Appearance</p>
                  <label class="theme-menu-option">
                    <input
                      type="radio"
                      name="theme-mode-desktop"
                      value="light"
                      data-theme-mode-option="light"
                    />
                    <span class="theme-menu-option-title">Light</span>
                  </label>
                  <label class="theme-menu-option">
                    <input
                      type="radio"
                      name="theme-mode-desktop"
                      value="dark"
                      data-theme-mode-option="dark"
                    />
                    <span class="theme-menu-option-title">Dark</span>
                  </label>
                  <label class="theme-menu-option">
                    <input
                      type="radio"
                      name="theme-mode-desktop"
                      value="oled"
                      data-theme-mode-option="oled"
                    />
                    <span class="theme-menu-option-title">OLED</span>
                  </label>
                  <label class="theme-menu-option">
                    <input
                      type="radio"
                      name="theme-mode-desktop"
                      value="auto"
                      data-theme-mode-option="auto"
                    />
                    <span class="theme-menu-option-title">Auto</span>
                  </label>
                </div>
                <div class="theme-menu-section" data-theme-auto-group aria-hidden="true">
                  <p class="theme-menu-heading">When system is dark</p>
                  <label class="theme-menu-option">
                    <input
                      type="radio"
                      name="theme-auto-desktop"
                      value="dark"
                      data-theme-auto-option="dark"
                    />
                    <span class="theme-menu-option-title">Dimmed dark</span>
                  </label>
                  <label class="theme-menu-option">
                    <input
                      type="radio"
                      name="theme-auto-desktop"
                      value="oled"
                      data-theme-auto-option="oled"
                    />
                    <span class="theme-menu-option-title">Pure black (OLED)</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="md:hidden theme-menu-root" data-theme-menu-root>
            <button
              type="button"
              data-theme-menu-toggle
              class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 dark:border-slate-700 text-lg text-slate-600 dark:text-slate-200 hover:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/60 theme-toggle-control"
              aria-label="Open theme menu"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="theme-menu-compact"
            >
              <span data-theme-icon class="leading-none">☀️</span>
            </button>
            <div
              id="theme-menu-compact"
              class="theme-menu theme-menu-compact"
              data-theme-menu-panel
              role="menu"
              aria-hidden="true"
            >
              <div class="theme-menu-section" role="none">
                <p class="theme-menu-heading">Appearance</p>
                <label class="theme-menu-option">
                  <input
                    type="radio"
                    name="theme-mode-compact"
                    value="light"
                    data-theme-mode-option="light"
                  />
                  <span class="theme-menu-option-title">Light</span>
                </label>
                <label class="theme-menu-option">
                  <input
                    type="radio"
                    name="theme-mode-compact"
                    value="dark"
                    data-theme-mode-option="dark"
                  />
                  <span class="theme-menu-option-title">Dark</span>
                </label>
                <label class="theme-menu-option">
                  <input
                    type="radio"
                    name="theme-mode-compact"
                    value="oled"
                    data-theme-mode-option="oled"
                  />
                  <span class="theme-menu-option-title">OLED</span>
                </label>
                <label class="theme-menu-option">
                  <input
                    type="radio"
                    name="theme-mode-compact"
                    value="auto"
                    data-theme-mode-option="auto"
                  />
                  <span class="theme-menu-option-title">Auto</span>
                </label>
              </div>
              <div class="theme-menu-section" data-theme-auto-group aria-hidden="true">
                <p class="theme-menu-heading">When system is dark</p>
                <label class="theme-menu-option">
                  <input
                    type="radio"
                    name="theme-auto-compact"
                    value="dark"
                    data-theme-auto-option="dark"
                  />
                  <span class="theme-menu-option-title">Dimmed dark</span>
                </label>
                <label class="theme-menu-option">
                  <input
                    type="radio"
                    name="theme-auto-compact"
                    value="oled"
                    data-theme-auto-option="oled"
                  />
                  <span class="theme-menu-option-title">Pure black (OLED)</span>
                </label>
              </div>
            </div>
          </div>
          <button
            type="button"
            class="mobile-nav-toggle md:hidden"
            data-mobile-nav-toggle
            aria-expanded="false"
            aria-controls="mobile-nav-panel"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="mobile-nav-toggle-line"></span>
            <span class="mobile-nav-toggle-line"></span>
            <span class="mobile-nav-toggle-line"></span>
          </button>
        </div>
      </div>
      <div id="mobile-nav-panel" class="mobile-nav-panel md:hidden" aria-hidden="true">
        <div class="mobile-nav-panel-inner">
          <a href="/" data-nav-index="0" class="mobile-nav-link">Dashboard</a>
          <a href="/what-if" data-nav-index="1" class="mobile-nav-link">What If</a>
          <a href="/settings" data-nav-index="2" class="mobile-nav-link">Settings</a>
          <a href="/debug" data-nav-index="3" class="mobile-nav-link">Debug</a>
          <a
            href="/docs"
            data-nav-index="4"
            class="mobile-nav-link"
            target="_blank"
            rel="noopener noreferrer"
            >API Docs</a
          >
          <div class="mobile-nav-divider"></div>
          <div class="mobile-theme-menu" role="presentation">
            <p class="mobile-theme-heading">Theme</p>
            <div class="mobile-theme-options" role="radiogroup" aria-label="Theme mode">
              <label class="theme-menu-option">
                <input
                  type="radio"
                  name="theme-mode-mobile"
                  value="light"
                  data-theme-mode-option="light"
                />
                <span class="theme-menu-option-title">Light</span>
              </label>
              <label class="theme-menu-option">
                <input
                  type="radio"
                  name="theme-mode-mobile"
                  value="dark"
                  data-theme-mode-option="dark"
                />
                <span class="theme-menu-option-title">Dark</span>
              </label>
              <label class="theme-menu-option">
                <input
                  type="radio"
                  name="theme-mode-mobile"
                  value="oled"
                  data-theme-mode-option="oled"
                />
                <span class="theme-menu-option-title">OLED</span>
              </label>
              <label class="theme-menu-option">
                <input
                  type="radio"
                  name="theme-mode-mobile"
                  value="auto"
                  data-theme-mode-option="auto"
                />
                <span class="theme-menu-option-title">Auto</span>
              </label>
            </div>
            <div class="mobile-theme-auto" data-theme-auto-group aria-hidden="true">
              <p class="mobile-theme-subheading">When system is dark</p>
              <label class="theme-menu-option">
                <input
                  type="radio"
                  name="theme-auto-mobile"
                  value="dark"
                  data-theme-auto-option="dark"
                />
                <span class="theme-menu-option-title">Dimmed dark</span>
              </label>
              <label class="theme-menu-option">
                <input
                  type="radio"
                  name="theme-auto-mobile"
                  value="oled"
                  data-theme-auto-option="oled"
                />
                <span class="theme-menu-option-title">Pure black (OLED)</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div id="mobile-nav-backdrop" class="mobile-nav-backdrop md:hidden" aria-hidden="true"></div>
    <main class="max-w-6xl mx-auto px-6 py-10">
      {% block content %}{% endblock %}
    </main>
    <footer class="max-w-6xl mx-auto px-6 py-6 text-sm text-slate-500 dark:text-slate-400">
      &copy; {{ current_year }} Inbox Steward. Made with local AI magic.
    </footer>
    <script>
      const controller = window.__themeController;
      const icons = { light: '☀️', dark: '🌙', oled: '🖤' };
      const labels = { light: 'Light', dark: 'Dark', oled: 'OLED' };
      const themeMenuRoots = Array.from(document.querySelectorAll('[data-theme-menu-root]'));
      const themeMenuToggles = Array.from(document.querySelectorAll('[data-theme-menu-toggle]'));
      const themeModeInputs = Array.from(document.querySelectorAll('[data-theme-mode-option]'));
      const themeAutoGroups = Array.from(document.querySelectorAll('[data-theme-auto-group]'));
      const themeAutoInputs = Array.from(document.querySelectorAll('[data-theme-auto-option]'));

      const getThemeSettings = () => {
        if (controller && typeof controller.settings === 'function') {
          return controller.settings();
        }
        return { mode: 'light', autoDark: 'dark' };
      };

      const getResolvedTheme = () => {
        if (controller && typeof controller.current === 'function') {
          return controller.current();
        }
        return 'light';
      };

      const formatDisplayLabel = (settings, resolved) => {
        if (!settings || !settings.mode) {
          return labels[resolved] || resolved;
        }
        if (settings.mode === 'auto') {
          const target = settings.autoDark === 'oled' ? 'OLED' : 'Dark';
          return `Auto (${target})`;
        }
        return labels[settings.mode] || settings.mode;
      };

      const updateThemeDisplays = () => {
        const settings = getThemeSettings();
        const resolved = getResolvedTheme();
        const iconValue = icons[resolved] || '☀️';
        const labelText = formatDisplayLabel(settings, resolved);
        themeMenuToggles.forEach((toggle) => {
          const iconEl = toggle.querySelector('[data-theme-icon]');
          const labelEl = toggle.querySelector('[data-theme-label]');
          if (iconEl) iconEl.textContent = iconValue;
          if (labelEl) labelEl.textContent = labelText;
          if (toggle.hasAttribute('aria-label')) {
            toggle.setAttribute('aria-label', `Change theme (current: ${labelText})`);
          }
        });
      };

      const updateThemeOptions = () => {
        const settings = getThemeSettings();
        themeModeInputs.forEach((input) => {
          const value = input.dataset.themeModeOption;
          if (!value) return;
          if (value === 'auto') {
            input.checked = settings.mode === 'auto';
          } else {
            input.checked = settings.mode === value;
          }
        });
        themeAutoGroups.forEach((group) => {
          const isVisible = settings.mode === 'auto';
          group.classList.toggle('is-visible', isVisible);
          group.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
        });
        themeAutoInputs.forEach((input) => {
          const value = input.dataset.themeAutoOption;
          if (!value) return;
          input.checked = settings.autoDark === value;
        });
      };

      const updateThemeUI = () => {
        updateThemeDisplays();
        updateThemeOptions();
      };

      let openThemeMenuRoot = null;

      const closeThemeMenu = (root) => {
        if (!root) return;
        const toggle = root.querySelector('[data-theme-menu-toggle]');
        const panel = root.querySelector('[data-theme-menu-panel]');
        if (toggle) {
          toggle.setAttribute('aria-expanded', 'false');
          toggle.classList.remove('is-open');
        }
        if (panel) {
          panel.setAttribute('aria-hidden', 'true');
          panel.classList.remove('is-open');
        }
        if (openThemeMenuRoot === root) {
          openThemeMenuRoot = null;
        }
      };

      const closeAllThemeMenus = () => {
        themeMenuRoots.forEach((root) => closeThemeMenu(root));
      };

      const openThemeMenu = (root) => {
        if (!root) return;
        const toggle = root.querySelector('[data-theme-menu-toggle]');
        const panel = root.querySelector('[data-theme-menu-panel]');
        if (!toggle || !panel) return;
        closeAllThemeMenus();
        toggle.setAttribute('aria-expanded', 'true');
        toggle.classList.add('is-open');
        panel.setAttribute('aria-hidden', 'false');
        panel.classList.add('is-open');
        openThemeMenuRoot = root;
      };

      themeMenuRoots.forEach((root) => {
        const toggle = root.querySelector('[data-theme-menu-toggle]');
        const panel = root.querySelector('[data-theme-menu-panel]');
        if (!toggle) return;
        toggle.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const expanded = toggle.getAttribute('aria-expanded') === 'true';
          if (expanded) {
            closeThemeMenu(root);
          } else {
            openThemeMenu(root);
          }
        });
        if (panel) {
          panel.addEventListener('click', (event) => {
            event.stopPropagation();
          });
        }
      });

      document.addEventListener('click', (event) => {
        if (!openThemeMenuRoot) return;
        if (!openThemeMenuRoot.contains(event.target)) {
          closeAllThemeMenus();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && openThemeMenuRoot) {
          closeAllThemeMenus();
        }
      });

      themeModeInputs.forEach((input) => {
        input.addEventListener('change', (event) => {
          if (!controller || !event.target.checked) return;
          const value = event.target.dataset.themeModeOption;
          if (!value) return;
          controller.apply(value);
          updateThemeUI();
          if (value !== 'auto') {
            closeAllThemeMenus();
          }
        });
      });

      themeAutoInputs.forEach((input) => {
        input.addEventListener('change', (event) => {
          if (!controller || !event.target.checked) return;
          const value = event.target.dataset.themeAutoOption;
          if (!value) return;
          controller.setAutoPreference(value);
          updateThemeUI();
        });
      });

      document.addEventListener('themechange', updateThemeUI);
      updateThemeUI();

      const preloader = document.getElementById('preloader');
      const preloaderLogo = document.querySelector('[data-preloader-logo]');
      const SKIP_PRELOADER_KEY = 'inbox-steward:skip-preloader';

      const resolveNavigationType = () => {
        const [entry] = performance.getEntriesByType('navigation');
        if (entry && entry.type) {
          return entry.type;
        }
        if (performance.navigation) {
          const { type } = performance.navigation;
          if (type === performance.navigation.TYPE_RELOAD || type === 1) {
            return 'reload';
          }
          if (type === performance.navigation.TYPE_BACK_FORWARD || type === 2) {
            return 'back_forward';
          }
        }
        return 'navigate';
      };

      const navigationType = resolveNavigationType();
      let skipRequested = false;
      try {
        skipRequested = sessionStorage.getItem(SKIP_PRELOADER_KEY) === 'true';
        if (skipRequested) {
          sessionStorage.removeItem(SKIP_PRELOADER_KEY);
        }
      } catch (error) {
        skipRequested = false;
      }

      const shouldRunPreloader = Boolean(preloader) && !(skipRequested && navigationType !== 'reload');

      if (!shouldRunPreloader) {
        document.body.classList.remove('preloader-active');
        if (preloader && preloader.parentElement) {
          preloader.classList.add('is-hidden');
          preloader.parentElement.removeChild(preloader);
        }
      } else {
        const PRELOADER_MIN_MS = 1400;
        const PRELOADER_FAILSAFE_MS = 7000;
        const preloaderStart = performance.now();
        let preloaderLaunchStarted = false;

        const removePreloader = () => {
          if (!preloader || preloader.classList.contains('is-hidden')) {
            document.body.classList.remove('preloader-active');
            return;
          }
          preloader.classList.add('is-hidden');
          document.body.classList.remove('preloader-active');
          window.setTimeout(() => {
            if (preloader && preloader.parentElement) {
              preloader.parentElement.removeChild(preloader);
            }
          }, 1100);
        };

        const launchPreloader = () => {
          if (!preloader || preloaderLaunchStarted) {
            document.body.classList.remove('preloader-active');
            return;
          }
          preloaderLaunchStarted = true;
          preloader.classList.add('is-launching');
          document.body.classList.remove('preloader-active');
          window.setTimeout(removePreloader, 1250);
        };

        const finishPreloader = () => {
          if (!preloader || preloaderLaunchStarted) {
            return;
          }
          const elapsed = performance.now() - preloaderStart;
          const wait = Math.max(PRELOADER_MIN_MS - elapsed, 0);
          window.setTimeout(launchPreloader, wait);
        };

        if (preloaderLogo) {
          preloaderLogo.addEventListener('error', () => {
            preloaderLogo.classList.add('is-hidden');
          });
        }

        window.addEventListener('load', () => {
          window.setTimeout(finishPreloader, 200);
        });

        window.setTimeout(launchPreloader, PRELOADER_FAILSAFE_MS);
      }

      window.addEventListener('beforeunload', () => {
        try {
          sessionStorage.setItem(SKIP_PRELOADER_KEY, 'true');
        } catch (error) {
          // Ignore storage exceptions; preloader will show next visit.
        }
      });

      const navRoot = document.querySelector('nav');
      const navToggle = document.querySelector('[data-mobile-nav-toggle]');
      const navPanel = document.getElementById('mobile-nav-panel');
      const navBackdrop = document.getElementById('mobile-nav-backdrop');

      const updateNavHeight = () => {
        if (!navRoot) return;
        const height = navRoot.offsetHeight;
        document.documentElement.style.setProperty('--nav-height', `${height}px`);
      };
      updateNavHeight();

      const setMobileNavState = (open) => {
        if (navToggle) {
          navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          navToggle.classList.toggle('is-open', open);
        }
        if (navPanel) {
          navPanel.classList.toggle('is-open', open);
          navPanel.setAttribute('aria-hidden', open ? 'false' : 'true');
        }
        if (navBackdrop) {
          navBackdrop.classList.toggle('is-visible', open);
          navBackdrop.setAttribute('aria-hidden', open ? 'false' : 'true');
        }
        document.body.classList.toggle('mobile-nav-open', !!open);
      };

      const closeMobileNav = () => setMobileNavState(false);

      if (navToggle && navPanel) {
        navToggle.addEventListener('click', () => {
          const expanded = navToggle.getAttribute('aria-expanded') === 'true';
          closeAllThemeMenus();
          setMobileNavState(!expanded);
        });
      }

      if (navBackdrop) {
        navBackdrop.addEventListener('click', closeMobileNav);
      }

      const handleResize = () => {
        updateNavHeight();
        if (window.innerWidth >= 768) {
          closeMobileNav();
        }
      };

      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', handleResize);
      window.addEventListener('load', updateNavHeight);

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeMobileNav();
        }
      });

      const applyPageEnter = () => {
        const main = document.querySelector('main');
        if (!main) return;
        const direction = sessionStorage.getItem('page-transition-direction');
        sessionStorage.removeItem('page-transition-direction');
        const enterClass =
          direction === 'left'
            ? 'page-enter-left'
            : direction === 'right'
            ? 'page-enter-right'
            : 'page-enter-neutral';
        main.classList.add(enterClass);
        main.addEventListener(
          'animationend',
          () => {
            main.classList.remove('page-enter-left', 'page-enter-right', 'page-enter-neutral');
          },
          { once: true },
        );
      };

      document.addEventListener('DOMContentLoaded', applyPageEnter);

      const navLinks = Array.from(document.querySelectorAll('nav a[data-nav-index]'));
      const currentPath = window.location.pathname.replace(/\/+$/, '') || '/';
      const resolveIndex = (link) => {
        const value = link.getAttribute('data-nav-index');
        return value !== null ? Number.parseInt(value, 10) : 0;
      };
      const currentIndex = navLinks.findIndex((link) => link.getAttribute('href') === currentPath);

      navLinks.forEach((link) => {
        link.addEventListener('click', (event) => {
          closeAllThemeMenus();
          closeMobileNav();
          if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
            return;
          }
          if (link.target === '_blank') {
            return;
          }
          const main = document.querySelector('main');
          if (!main) {
            return;
          }
          if (link.getAttribute('href') === window.location.pathname) {
            return;
          }
          const targetIndex = resolveIndex(link);
          if (currentIndex === -1 || Number.isNaN(targetIndex) || targetIndex === currentIndex) {
            return;
          }
          event.preventDefault();
          const direction = targetIndex < currentIndex ? 'left' : 'right';
          sessionStorage.setItem('page-transition-direction', direction);
          main.classList.add(direction === 'left' ? 'page-exit-left' : 'page-exit-right');
          setTimeout(() => {
            window.location.href = link.href;
          }, 200);
        });
      });
    </script>
  </body>
</html>
