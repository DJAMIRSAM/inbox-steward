{% extends "base.html" %}
{% block content %}
<section class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm p-8">
  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">Diagnostics</h1>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">
        Confirm Inbox Steward can reach your mailbox, Ollama model, and Home Assistant notification target.
      </p>
    </div>
    <form method="post" class="flex items-center gap-3">
      <input type="hidden" name="action" value="run_audit" />
      <button
        type="submit"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white shadow-sm"
      >
        <span>Run connectivity audit</span>
      </button>
    </form>
  </div>

  {% if flash %}
  {% if flash.status == 'success' %}
  {% set flash_classes = 'border-green-300 bg-emerald-50 text-emerald-700 dark:border-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200' %}
  {% elif flash.status == 'error' %}
  {% set flash_classes = 'border-rose-300 bg-rose-50 text-rose-700 dark:border-rose-800 dark:bg-rose-900/40 dark:text-rose-200' %}
  {% else %}
  {% set flash_classes = 'border-slate-200 bg-slate-50 text-slate-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200' %}
  {% endif %}
  <div class="mt-6 px-4 py-3 rounded-xl border {{ flash_classes }}">
    {{ flash.message }}
  </div>
  {% endif %}

  <div class="mt-6 grid gap-6 md:grid-cols-2">
    <div class="border border-slate-200 dark:border-slate-800 rounded-xl p-5 bg-slate-50/60 dark:bg-slate-900/40">
      <h2 class="text-sm font-semibold text-slate-700 dark:text-slate-200 uppercase tracking-wide">Service configuration</h2>
      <dl class="mt-4 space-y-3 text-sm text-slate-600 dark:text-slate-300">
        <div class="flex items-center justify-between gap-3">
          <dt class="font-medium">IMAP</dt>
          <dd class="text-right">
            <div>{{ overview.imap.host }} &middot; {{ overview.imap.mailbox }}</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">{{ overview.imap.username }} &middot; poll {{ overview.imap.poll }}s</div>
          </dd>
        </div>
        <div class="flex items-center justify-between gap-3">
          <dt class="font-medium">Ollama</dt>
          <dd class="text-right">
            <div>{{ overview.ollama.endpoint }}</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">Model: {{ overview.ollama.model }}</div>
          </dd>
        </div>
        <div class="flex items-center justify-between gap-3">
          <dt class="font-medium">Home Assistant</dt>
          <dd class="text-right">
            <div>{{ overview.home_assistant.base_url or '—' }}</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">Target: {{ overview.home_assistant.target or '—' }}</div>
          </dd>
        </div>
        <div class="flex items-center justify-between gap-3">
          <dt class="font-medium">Database</dt>
          <dd class="text-right truncate" title="{{ overview.database.url }}">{{ overview.database.url }}</dd>
        </div>
      </dl>
    </div>
    <div class="border border-slate-200 dark:border-slate-800 rounded-xl p-5 bg-slate-50/60 dark:bg-slate-900/40">
      <h2 class="text-sm font-semibold text-slate-700 dark:text-slate-200 uppercase tracking-wide">Last audit snapshot</h2>
      {% set audit = results.audit %}
      {% if audit %}
      <ul class="mt-4 space-y-2 text-sm">
        {% for key, label in {'imap': 'IMAP login', 'folders': 'Folder tree', 'ollama': 'Ollama API', 'home_assistant': 'Home Assistant'}.items() %}
        {% set ok = audit.get(key) %}
        <li class="flex items-center justify-between gap-3">
          <span class="text-slate-600 dark:text-slate-300">{{ label }}</span>
          {% if ok %}
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700 dark:bg-emerald-900/60 dark:text-emerald-200">
            <span>●</span>
            Passing
          </span>
          {% else %}
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-rose-100 text-rose-700 dark:bg-rose-900/60 dark:text-rose-200">
            <span>●</span>
            Attention needed
          </span>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      <p class="mt-4 text-xs text-slate-500 dark:text-slate-400">Run a new audit anytime to refresh these results.</p>
      {% else %}
      <p class="mt-4 text-sm text-slate-500 dark:text-slate-300">
        No audit has been run yet. Use the button above to execute all connectivity checks at once.
      </p>
      {% endif %}
    </div>
  </div>

  <div class="mt-8 grid gap-6 xl:grid-cols-2">
    <div class="border border-slate-200 dark:border-slate-800 rounded-xl p-5 bg-white dark:bg-slate-900 flex flex-col gap-4">
      <div>
        <h2 class="text-lg font-medium text-slate-800 dark:text-slate-100">IMAP mailbox</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400">Pulls the newest message and shows a quick preview.</p>
      </div>
      <form method="post" class="mt-auto">
        <input type="hidden" name="action" value="test_email" />
        <button type="submit" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg shadow-sm">Fetch latest message</button>
      </form>
      <div class="text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 rounded-lg p-4">
        {% set email = results.email %}
        {% if email is none %}
        <p class="text-slate-400 dark:text-slate-500">No test run yet.</p>
        {% elif email.ok %}
        <dl class="space-y-2">
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Subject</dt>
            <dd class="font-medium text-slate-800 dark:text-slate-100">{{ email.message.subject or '—' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">From</dt>
            <dd>{{ email.message.sender or '—' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Received</dt>
            <dd>{{ email.message.received_at or '—' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Folder</dt>
            <dd>{{ email.message.folder or '—' }}</dd>
          </div>
          <div>
            <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Preview</dt>
            <dd class="text-slate-700 dark:text-slate-200">{{ email.message.snippet or '—' }}</dd>
          </div>
        </dl>
        {% else %}
        <p class="text-rose-600 dark:text-rose-300">{{ email.error }}</p>
        {% endif %}
      </div>
    </div>

    <div class="border border-slate-200 dark:border-slate-800 rounded-xl p-5 bg-white dark:bg-slate-900 flex flex-col gap-4">
      <div>
        <h2 class="text-lg font-medium text-slate-800 dark:text-slate-100">Mailbox folders</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400">Lists every IMAP folder the assistant can see.</p>
      </div>
      <form method="post" class="mt-auto">
        <input type="hidden" name="action" value="list_folders" />
        <button type="submit" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg shadow-sm">Refresh folder tree</button>
      </form>
      <div class="text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 rounded-lg p-4 max-h-64 overflow-y-auto">
        {% set folder_result = results.folders %}
        {% if folder_result is none %}
        <p class="text-slate-400 dark:text-slate-500">No folder check yet.</p>
        {% elif folder_result.ok %}
        <ul class="space-y-1 font-mono text-xs">
          {% for folder in folder_result.folders %}
          <li class="text-slate-700 dark:text-slate-200">{{ folder }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-rose-600 dark:text-rose-300">{{ folder_result.error }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="mt-8 grid gap-6 md:grid-cols-2">
    <div class="border border-slate-200 dark:border-slate-800 rounded-xl p-5 bg-white dark:bg-slate-900 flex flex-col gap-4">
      <div>
        <h2 class="text-lg font-medium text-slate-800 dark:text-slate-100">Ollama model</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400">Sends a friendly hello and shows the model response.</p>
      </div>
      <form method="post" class="mt-auto">
        <input type="hidden" name="action" value="test_ollama" />
        <button type="submit" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg shadow-sm">Ping Ollama</button>
      </form>
      <div class="text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 rounded-lg p-4">
        {% set ollama = results.ollama %}
        {% if ollama is none %}
        <p class="text-slate-400 dark:text-slate-500">No test run yet.</p>
        {% elif ollama.ok %}
        <p class="text-slate-700 dark:text-slate-200">{{ ollama.response }}</p>
        {% else %}
        <p class="text-rose-600 dark:text-rose-300">{{ ollama.error }}</p>
        {% endif %}
      </div>
    </div>

    <div class="border border-slate-200 dark:border-slate-800 rounded-xl p-5 bg-white dark:bg-slate-900 flex flex-col gap-4">
      <div>
        <h2 class="text-lg font-medium text-slate-800 dark:text-slate-100">Home Assistant</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400">Pushes a one-off test notification to your configured mobile target.</p>
      </div>
      <form method="post" class="mt-auto">
        <input type="hidden" name="action" value="test_home_assistant" />
        <button type="submit" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg shadow-sm">Send test notification</button>
      </form>
      <div class="text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 rounded-lg p-4">
        {% set ha = results.home_assistant %}
        {% if ha is none %}
        <p class="text-slate-400 dark:text-slate-500">No test run yet.</p>
        {% elif ha.ok %}
        <p class="text-slate-700 dark:text-slate-200">Notification request accepted (HTTP {{ ha.status }}).</p>
        {% else %}
        <p class="text-rose-600 dark:text-rose-300">{{ ha.error }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}
